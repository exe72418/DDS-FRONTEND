{"version":3,"file":"ngxs-storage-plugin.mjs","sources":["../../../packages/storage-plugin/src/internals.ts","../../../packages/storage-plugin/src/keys-manager.ts","../../../packages/storage-plugin/src/storage.plugin.ts","../../../packages/storage-plugin/src/storage.module.ts","../../../packages/storage-plugin/src/with-storage-feature.ts","../../../packages/storage-plugin/src/engines.ts","../../../packages/storage-plugin/index.ts","../../../packages/storage-plugin/ngxs-storage-plugin.ts"],"sourcesContent":["import { isPlatformServer } from '@angular/common';\nimport {\n  ɵDEFAULT_STATE_KEY,\n  StorageOption,\n  StorageEngine,\n  NgxsStoragePluginOptions,\n  ɵNgxsTransformedStoragePluginOptions\n} from '@ngxs/storage-plugin/internals';\n\nexport function storageOptionsFactory(\n  options: NgxsStoragePluginOptions\n): ɵNgxsTransformedStoragePluginOptions {\n  return {\n    storage: StorageOption.LocalStorage,\n    serialize: JSON.stringify,\n    deserialize: JSON.parse,\n    beforeSerialize: obj => obj,\n    afterDeserialize: obj => obj,\n    ...options,\n    keys: options.keys === '*' ? [ɵDEFAULT_STATE_KEY] : options.keys\n  };\n}\n\nexport function engineFactory(\n  options: NgxsStoragePluginOptions,\n  platformId: string\n): StorageEngine | null {\n  if (isPlatformServer(platformId)) {\n    return null;\n  }\n\n  if (options.storage === StorageOption.LocalStorage) {\n    return localStorage;\n  } else if (options.storage === StorageOption.SessionStorage) {\n    return sessionStorage;\n  }\n\n  return null;\n}\n\nexport function getStorageKey(key: string, options?: NgxsStoragePluginOptions): string {\n  // Prepends the `namespace` option to any key if it's been provided by a user.\n  // So `@@STATE` becomes `my-app:@@STATE`.\n  return options?.namespace ? `${options.namespace}:${key}` : key;\n}\n","import { Injectable, Injector, inject } from '@angular/core';\nimport {\n  STORAGE_ENGINE,\n  StorageEngine,\n  StorageKey,\n  ɵextractStringKey,\n  ɵisKeyWithExplicitEngine,\n  ɵNGXS_STORAGE_PLUGIN_OPTIONS\n} from '@ngxs/storage-plugin/internals';\n\ninterface KeyWithEngine {\n  key: string;\n  engine: StorageEngine;\n}\n\n@Injectable({ providedIn: 'root' })\nexport class ɵNgxsStoragePluginKeysManager {\n  /** Store keys separately in a set so we're able to check if the key already exists. */\n  private readonly _keys = new Set<string>();\n\n  private readonly _injector = inject(Injector);\n\n  private readonly _keysWithEngines: KeyWithEngine[] = [];\n\n  constructor() {\n    const { keys } = inject(ɵNGXS_STORAGE_PLUGIN_OPTIONS);\n    this.addKeys(keys);\n  }\n\n  getKeysWithEngines() {\n    // Spread to prevent external code from directly modifying the internal state.\n    return [...this._keysWithEngines];\n  }\n\n  addKeys(storageKeys: StorageKey[]): void {\n    for (const storageKey of storageKeys) {\n      const key = ɵextractStringKey(storageKey);\n\n      // The user may call `withStorageFeature` with the same state multiple times.\n      // Let's prevent duplicating state names in the `keysWithEngines` list.\n      // Please note that calling provideStates multiple times with the same state is\n      // acceptable behavior. This may occur because the state could be necessary at the\n      // feature level, and different parts of the application might require its registration.\n      // Consequently, `withStorageFeature` may also be called multiple times.\n      if (this._keys.has(key)) {\n        continue;\n      }\n\n      this._keys.add(key);\n\n      const engine = ɵisKeyWithExplicitEngine(storageKey)\n        ? this._injector.get(storageKey.engine)\n        : this._injector.get(STORAGE_ENGINE);\n\n      this._keysWithEngines.push({ key, engine });\n    }\n  }\n}\n","import { PLATFORM_ID, Inject, Injectable, inject } from '@angular/core';\nimport { isPlatformServer } from '@angular/common';\nimport { ɵPlainObject } from '@ngxs/store/internals';\nimport {\n  NgxsPlugin,\n  setValue,\n  getValue,\n  InitState,\n  UpdateState,\n  actionMatcher,\n  NgxsNextPluginFn\n} from '@ngxs/store/plugins';\nimport {\n  ɵDEFAULT_STATE_KEY,\n  ɵALL_STATES_PERSISTED,\n  NgxsStoragePluginOptions,\n  ɵNGXS_STORAGE_PLUGIN_OPTIONS\n} from '@ngxs/storage-plugin/internals';\nimport { tap } from 'rxjs/operators';\n\nimport { getStorageKey } from './internals';\nimport { ɵNgxsStoragePluginKeysManager } from './keys-manager';\n\ndeclare const ngDevMode: boolean;\n\nconst NG_DEV_MODE = typeof ngDevMode !== 'undefined' && ngDevMode;\n\n@Injectable()\nexport class NgxsStoragePlugin implements NgxsPlugin {\n  private _allStatesPersisted = inject(ɵALL_STATES_PERSISTED);\n\n  constructor(\n    private _keysManager: ɵNgxsStoragePluginKeysManager,\n    @Inject(ɵNGXS_STORAGE_PLUGIN_OPTIONS) private _options: NgxsStoragePluginOptions,\n    @Inject(PLATFORM_ID) private _platformId: string\n  ) {}\n\n  handle(state: any, event: any, next: NgxsNextPluginFn) {\n    if (isPlatformServer(this._platformId)) {\n      return next(state, event);\n    }\n\n    const matches = actionMatcher(event);\n    const isInitAction = matches(InitState);\n    const isUpdateAction = matches(UpdateState);\n    const isInitOrUpdateAction = isInitAction || isUpdateAction;\n    let hasMigration = false;\n\n    if (isInitOrUpdateAction) {\n      const addedStates: ɵPlainObject = isUpdateAction && event.addedStates;\n\n      for (const { key, engine } of this._keysManager.getKeysWithEngines()) {\n        // We're checking what states have been added by NGXS and if any of these states should be handled by\n        // the storage plugin. For instance, we only want to deserialize the `auth` state, NGXS has added\n        // the `user` state, the storage plugin will be rerun and will do redundant deserialization.\n        // `usesDefaultStateKey` is necessary to check since `event.addedStates` never contains `@@STATE`.\n        if (!this._allStatesPersisted && addedStates) {\n          // We support providing keys that can be deeply nested via dot notation, for instance,\n          // `keys: ['myState.myProperty']` is a valid key.\n          // The state name should always go first. The below code checks if the `key` includes dot\n          // notation and extracts the state name out of the key.\n          // Given the `key` is `myState.myProperty`, the `addedStates` will only contain `myState`.\n          const dotNotationIndex = key.indexOf(DOT);\n          const stateName = dotNotationIndex > -1 ? key.slice(0, dotNotationIndex) : key;\n          if (!addedStates.hasOwnProperty(stateName)) {\n            continue;\n          }\n        }\n\n        const storageKey = getStorageKey(key, this._options);\n        let storedValue: any = engine.getItem(storageKey);\n\n        if (storedValue !== 'undefined' && storedValue != null) {\n          try {\n            const newVal = this._options.deserialize!(storedValue);\n            storedValue = this._options.afterDeserialize!(newVal, key);\n          } catch {\n            NG_DEV_MODE &&\n              console.error(\n                `Error ocurred while deserializing the ${storageKey} store value, falling back to empty object, the value obtained from the store: `,\n                storedValue\n              );\n\n            storedValue = {};\n          }\n\n          this._options.migrations?.forEach(strategy => {\n            const versionMatch =\n              strategy.version === getValue(storedValue, strategy.versionKey || 'version');\n            const keyMatch =\n              (!strategy.key && this._allStatesPersisted) || strategy.key === key;\n            if (versionMatch && keyMatch) {\n              storedValue = strategy.migrate(storedValue);\n              hasMigration = true;\n            }\n          });\n\n          if (this._allStatesPersisted) {\n            storedValue = this._hydrateSelectivelyOnUpdate(storedValue, addedStates);\n            state = { ...state, ...storedValue };\n          } else {\n            state = setValue(state, key, storedValue);\n          }\n        }\n      }\n    }\n\n    return next(state, event).pipe(\n      tap(nextState => {\n        if (isInitOrUpdateAction && !hasMigration) {\n          return;\n        }\n\n        for (const { key, engine } of this._keysManager.getKeysWithEngines()) {\n          let storedValue = nextState;\n\n          const storageKey = getStorageKey(key, this._options);\n\n          if (key !== ɵDEFAULT_STATE_KEY) {\n            storedValue = getValue(nextState, key);\n          }\n\n          try {\n            const newStoredValue = this._options.beforeSerialize!(storedValue, key);\n            engine.setItem(storageKey, this._options.serialize!(newStoredValue));\n          } catch (error: any) {\n            if (NG_DEV_MODE) {\n              if (\n                error &&\n                (error.name === 'QuotaExceededError' ||\n                  error.name === 'NS_ERROR_DOM_QUOTA_REACHED')\n              ) {\n                console.error(\n                  `The ${storageKey} store value exceeds the browser storage quota: `,\n                  storedValue\n                );\n              } else {\n                console.error(\n                  `Error ocurred while serializing the ${storageKey} store value, value not updated, the value obtained from the store: `,\n                  storedValue\n                );\n              }\n            }\n          }\n        }\n      })\n    );\n  }\n\n  private _hydrateSelectivelyOnUpdate(storedValue: any, addedStates: ɵPlainObject) {\n    // The `UpdateState` action is triggered whenever a feature state is added.\n    // The condition below is only satisfied when this action is triggered.\n    // Let's consider two states: `counter` and `@ngxs/router-plugin` state.\n    // When `provideStore` is called, `CounterState` is provided at the root level,\n    // while `@ngxs/router-plugin` is provided as a feature state. Previously, the storage\n    // plugin might have stored the value of the counter state as `10`. If `CounterState`\n    // implements the `ngxsOnInit` hook and sets the state to `999`, the storage plugin will\n    // reset the entire state when the `RouterState` is registered.\n    // Consequently, the `counter` state will revert back to `10` instead of `999`.\n\n    if (!storedValue || !addedStates || Object.keys(addedStates).length === 0) {\n      // Nothing to update if `addedStates` object is empty.\n      return storedValue;\n    }\n\n    // The `storedValue` can be the entire state when the default state key\n    // is used. However, if `addedStates` only contains the `router` value,\n    // we only want to merge the state with that `router` value.\n    // Given the `storedValue` is an object:\n    // `{ counter: 10, router: {...} }`\n    // This will only select the `router` object from the `storedValue`,\n    // avoiding unnecessary rehydration of the `counter` state.\n    return Object.keys(addedStates).reduce(\n      (accumulator, addedState) => {\n        if (storedValue.hasOwnProperty(addedState)) {\n          accumulator[addedState] = storedValue[addedState];\n        }\n        return accumulator;\n      },\n      <ɵPlainObject>{}\n    );\n  }\n}\n\nconst DOT = '.';\n","import {\n  NgModule,\n  ModuleWithProviders,\n  PLATFORM_ID,\n  EnvironmentProviders,\n  makeEnvironmentProviders\n} from '@angular/core';\nimport { withNgxsPlugin } from '@ngxs/store';\nimport { NGXS_PLUGINS } from '@ngxs/store/plugins';\nimport {\n  ɵUSER_OPTIONS,\n  STORAGE_ENGINE,\n  ɵNGXS_STORAGE_PLUGIN_OPTIONS,\n  NgxsStoragePluginOptions\n} from '@ngxs/storage-plugin/internals';\n\nimport { NgxsStoragePlugin } from './storage.plugin';\nimport { engineFactory, storageOptionsFactory } from './internals';\n\n@NgModule()\nexport class NgxsStoragePluginModule {\n  static forRoot(\n    options: NgxsStoragePluginOptions\n  ): ModuleWithProviders<NgxsStoragePluginModule> {\n    return {\n      ngModule: NgxsStoragePluginModule,\n      providers: [\n        {\n          provide: NGXS_PLUGINS,\n          useClass: NgxsStoragePlugin,\n          multi: true\n        },\n        {\n          provide: ɵUSER_OPTIONS,\n          useValue: options\n        },\n        {\n          provide: ɵNGXS_STORAGE_PLUGIN_OPTIONS,\n          useFactory: storageOptionsFactory,\n          deps: [ɵUSER_OPTIONS]\n        },\n        {\n          provide: STORAGE_ENGINE,\n          useFactory: engineFactory,\n          deps: [ɵNGXS_STORAGE_PLUGIN_OPTIONS, PLATFORM_ID]\n        }\n      ]\n    };\n  }\n}\n\nexport function withNgxsStoragePlugin(\n  options: NgxsStoragePluginOptions\n): EnvironmentProviders {\n  return makeEnvironmentProviders([\n    withNgxsPlugin(NgxsStoragePlugin),\n    {\n      provide: ɵUSER_OPTIONS,\n      useValue: options\n    },\n    {\n      provide: ɵNGXS_STORAGE_PLUGIN_OPTIONS,\n      useFactory: storageOptionsFactory,\n      deps: [ɵUSER_OPTIONS]\n    },\n    {\n      provide: STORAGE_ENGINE,\n      useFactory: engineFactory,\n      deps: [ɵNGXS_STORAGE_PLUGIN_OPTIONS, PLATFORM_ID]\n    }\n  ]);\n}\n","import {\n  inject,\n  EnvironmentProviders,\n  ENVIRONMENT_INITIALIZER,\n  makeEnvironmentProviders\n} from '@angular/core';\nimport { StorageKey, ɵALL_STATES_PERSISTED } from '@ngxs/storage-plugin/internals';\n\nimport { ɵNgxsStoragePluginKeysManager } from './keys-manager';\n\ndeclare const ngDevMode: boolean;\n\nconst NG_DEV_MODE = typeof ngDevMode !== 'undefined' && ngDevMode;\n\nexport function withStorageFeature(storageKeys: StorageKey[]): EnvironmentProviders {\n  return makeEnvironmentProviders([\n    {\n      provide: ENVIRONMENT_INITIALIZER,\n      multi: true,\n      useValue: () => {\n        const allStatesPersisted = inject(ɵALL_STATES_PERSISTED);\n\n        if (allStatesPersisted) {\n          if (NG_DEV_MODE) {\n            const message =\n              'The NGXS storage plugin is currently persisting all states because the `keys` ' +\n              'option was explicitly set to `*` at the root level. To selectively persist states, ' +\n              'consider explicitly specifying them, allowing for addition at the feature level.';\n\n            console.error(message);\n          }\n\n          // We should prevent the addition of any feature states to persistence\n          // if the `keys` property is set to `*`, as this could disrupt the algorithm\n          // used in the storage plugin. Instead, we should log an error in development\n          // mode. In production, it should continue to function, but act as a no-op.\n          return;\n        }\n\n        inject(ɵNgxsStoragePluginKeysManager).addKeys(storageKeys);\n      }\n    }\n  ]);\n}\n","import { InjectionToken, PLATFORM_ID, inject } from '@angular/core';\nimport { isPlatformBrowser } from '@angular/common';\nimport { StorageEngine } from '@ngxs/storage-plugin/internals';\n\ndeclare const ngDevMode: boolean;\n\nconst NG_DEV_MODE = typeof ngDevMode !== 'undefined' && ngDevMode;\n\nexport const LOCAL_STORAGE_ENGINE = new InjectionToken<StorageEngine | null>(\n  NG_DEV_MODE ? 'LOCAL_STORAGE_ENGINE' : '',\n  {\n    providedIn: 'root',\n    factory: () => (isPlatformBrowser(inject(PLATFORM_ID)) ? localStorage : null)\n  }\n);\n\nexport const SESSION_STORAGE_ENGINE = new InjectionToken<StorageEngine | null>(\n  NG_DEV_MODE ? 'SESSION_STORAGE_ENGINE' : '',\n  {\n    providedIn: 'root',\n    factory: () => (isPlatformBrowser(inject(PLATFORM_ID)) ? sessionStorage : null)\n  }\n);\n","/**\n * The public api for consumers of @ngxs/storage-plugin\n */\nexport * from './src/public_api';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './index';\n"],"names":["ɵDEFAULT_STATE_KEY","ɵNGXS_STORAGE_PLUGIN_OPTIONS","ɵextractStringKey","ɵisKeyWithExplicitEngine","NG_DEV_MODE","ɵALL_STATES_PERSISTED","i1.ɵNgxsStoragePluginKeysManager","ɵUSER_OPTIONS"],"mappings":"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"}